---
title: "CSH Emergency Presentation"
output: pdf_document
---

```{r libs, include=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(knitr)
library(tidyr)
library(readr)
```

```{r import, include=FALSE}
# CSH data
bcm_colorectal_cancer_NK_2_21_25 <- read_excel("bcm_colorectal_cancer.NK.2.21.25.xlsx", 
    col_types = c("numeric", "text", "date", 
        "text", "text", "text", "date", "date", 
        "date", "text", "text", "date", "date"))

# Social vuln index
SVI_2022_US_ZCTA <- read_csv("SVI_2022_US_ZCTA.csv")

# ACS income and remove weird row
ncols_income <- 171  #  Will break if columns vary.
coltype_str <- paste(c("cc", rep("d", 171 - 2)), collapse = '')
income2 <- read_csv("ACSST5Y2023.S1902-Data.csv", col_types = coltype_str, n_max = 1000)
income2 <- income2[-1,]

# Income column metadata
Metadata <- read_csv("ACSST5Y2023.S1902-Column-Metadata.csv")

Metadata <- Metadata %>% 
  mutate(Label_readable = gsub("!!", ": ", Label))

# separate wider delim()
```

Census data:

- `SVI_2022_US_ZCTA.csv` 20.7 MB
- `ACSST5Y2023.S1901-Data.csv` 28.5 MB
- `ACSST5Y2023.S1902-Data.csv` 35.8 MB




# Data size and tidying

```{r print}
dim(bcm_colorectal_cancer_NK_2_21_25)
```

```{r data prep, include=FALSE}
analytic_data <- bcm_colorectal_cancer_NK_2_21_25 %>% 
  mutate(
    ED_days = as.numeric(Date_of_first_diagnosis - ed_date, units="days"),
    Inp_days = as.numeric(Date_of_first_diagnosis - ip_date, units="days"),
    is_EP = case_when(
      ED_days <= 30 ~ TRUE,
      Inp_days <= 30 ~ TRUE,
      .default = FALSE
    ),
    Age_yrs_at_dx = as.numeric(Date_of_first_diagnosis - birth_dt_tm, units="days") / 365.25,
    race_desc_raw = case_when(
      race_desc_raw == "Unable to determine" ~ "Unable to Determine",  # merge upper/lower case D
      .default = race_desc_raw
    ),
    Race = as.factor(race_desc_raw)
  )
```




# Univariate

## Times from ED or inpatient to diagnosis

```{r qplots, echo=FALSE, message=FALSE, warning=FALSE}
qplot(analytic_data$ED_days)
qplot(analytic_data$Inp_days)
```

### Distribution of ED $\to$ dx time

```{r summ-ed-days}
summary(analytic_data$ED_days)
```

## Crude EP rate

```{r ep-rate, echo=FALSE}
analytic_data %>%
  count(is_EP) %>% 
  mutate(
    Total = sum(n),
    Percent = round(n / Total * 100, 1)
  ) %>% 
  kable()
```

## Race

```{r race, echo=FALSE}
analytic_data %>% 
  count(Race) %>% 
  arrange(desc(n)) %>% 
  mutate(
    Total = sum(n),
    Percent = round(n / Total * 100, 1)
  ) %>%
  kable()
```




# Bivariate

## Overview of analysis

- Simple proportion of EP divided by all cases (EP rate.)
- Associations with basic demographics
    - age
    - race
    - geography (region)
    - ZIP linked to (if possible):
        - CDC
        - per capita income (quintiles or absolute)

Broadly, same as Cosmos paper. https://pubmed.ncbi.nlm.nih.gov/39394724/

Zimolzak AJ, Khan SP, Singh H, Davila JA. Application of a digital quality measure for cancer diagnosis in Epic Cosmos. *J Am Med Inform Assoc.* 2025;32(1):227--229.

## Age

```{r bivariate-age, echo=FALSE, message=FALSE}
analytic_data %>%
  ggplot(aes(x = Age_yrs_at_dx, fill = is_EP)) +
  geom_histogram()

analytic_data %>% 
  ggplot(aes(x = Age_yrs_at_dx, fill = is_EP)) +
  geom_boxplot(notch = TRUE, outlier.size = 2, outlier.alpha = 0.75, outlier.shape = 1)

t.test(Age_yrs_at_dx ~ is_EP, data = analytic_data)
```

## Race

```{r race-assoc, echo=FALSE}
race_p_table <- analytic_data %>% 
  group_by(Race) %>% 
  summarise(
    Numer.EP = sum(is_EP),
    Denom = n(),
    Non.EP = Denom - Numer.EP,
    Percent.EP = round(mean(is_EP) * 100, 1)
  ) %>% 
  arrange(desc(Denom))

race_p_table %>% 
  select(Race, Numer.EP, Denom, Percent.EP) %>% 
  kable()

prop.test(race_p_table$Numer.EP, race_p_table$Denom)

race_contingency <- race_p_table %>% 
  select(Numer.EP, Non.EP)
  
fisher.test(race_contingency, simulate.p.value = TRUE)
# 2e+08 takes about 10 sec and still not enough.
# Default is 2e+05.
```
